<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>WebOS</title>
  <style>
    html,
    body {
      overflow: hidden;
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      font-family: sans-serif;
      background-color: #1e1e1e;
    }

    iframe {
      width: 100%;
      height: 100%;
      border: none;
    }

    #desktop {
      position: relative;
      width: 100%;
      height: 100%;
      background-image: url("background.png");
      background-repeat: no-repeat;
      background-attachment: fixed;
      background-size: cover;
    }

    /* Desktop icons */
    .desktop-icon {
      position: absolute;
      width: 80px;
      text-align: center;
      color: white;
      cursor: pointer;
      user-select: none;
    }

    .desktop-icon img {
      width: 64px;
      height: 64px;
      display: block;
      margin: 0 auto;
    }

    .desktop-icon span {
      display: block;
      margin-top: 5px;
      font-size: 12px;
    }

    /* Window styles */
    .window {
      position: absolute;
      background: #000000;
      border: 1px solid #ccc;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
      border-radius: 4px;
      overflow: hidden;
      display: block;
    }

    .window-header {
      position: relative;
      background: #8c8c8c;
      color: #fff;
      padding: 5px 10px;
      cursor: move;
      font-weight: bold;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .window-body {
      overflow: hidden;
      height: calc(100% - 29px);

    }

    .window-controls {
      display: flex;
      gap: 5px;
    }

    .window-controls span {
      cursor: pointer;
      user-select: none;
    }

    /* Taskbar styles */
    #taskbar {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      background: #333;
      color: #fff;
      height: 30px;
      display: flex;
      align-items: center;
      padding: 0 10px;
      box-sizing: border-box;
    }

    .taskbar-item {
      margin-right: 10px;
      cursor: pointer;
      padding: 2px 6px;
      background: #555;
      border-radius: 3px;
    }

    /* Resizable handle styles */
    .resize-handle {
      position: absolute;
      width: 16px;
      height: 16px;
      right: 0;
      bottom: 0;
      cursor: se-resize;
      background: rgba(0, 0, 0, 0.3);
    }

    #custom-menu {
      position: absolute;
      background-color: #222;
      color: #fff;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
      display: none;
      z-index: 1000;
      min-width: 150px;
    }

    #custom-menu ul {
      list-style: none;
      margin: 0;
      padding: 0;
    }

    #custom-menu li {
      padding: 10px 15px;
      cursor: pointer;
      border-bottom: 1px solid #444;
    }

    #custom-menu li:last-child {
      border-bottom: none;
    }

    #custom-menu li:hover {
      background-color: #444;
    }

    #start-button {
      background: #444;
      padding: 0px 10px;
      border-radius: 4px;
      margin-right: 10px;
      cursor: pointer;
    }

    #start-menu {
      position: absolute;
      bottom: 30px;
      left: 10px;
      background: #222;
      border-radius: 5px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
      color: white;
      display: none;
      min-width: 160px;
      z-index: 1001;
    }

    #start-menu ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    #start-menu li {
      padding: 15px 20px;
      border-bottom: 1px solid #333;
      cursor: pointer;
    }

    #start-menu li:last-child {
      border-bottom: none;
    }

    #start-menu li:hover {
      background-color: #444;
    }
  </style>
</head>

<body>
  <div id="desktop"></div>
  <div id="taskbar">
    <div id="start-button">☰</div>
  </div>

  <div id="custom-menu">
    <ul id="file-menu" style="display: none;">
      <li onclick="renameFile()">Rename</li>
      <li onclick="deleteFile()">Delete</li>
    </ul>
    <ul id="empty-menu" style="display: none;">
      <li onclick="createFile()">Create File</li>
      <li onclick="createFolder()">Create Folder</li>
    </ul>
  </div>


  <div id="start-menu">
    <ul>
      <li onclick="launchApp('File Explorer')">File Explorer</li>
      <li onclick="launchApp('Notepad')">Notepad</li>
      <li onclick="launchApp('Console')">Console</li>
    </ul>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/dexie/3.2.2/dexie.min.js"></script>
  <script>
    const db = new Dexie("FileSystemDB");
    db.version(15).stores({
      files: "++id, name, type, parentId, content, left, top, iconUrl"
    });
    const defaultApps = [
      {
        name: "File Explorer",
        type: "app",
        content: '<iframe src="explorer.html"></iframe>',
        left: 20,
        top: 20,
        iconUrl: "icons/explorer.png"
      },
      {
        name: "Console",
        type: "app",
        content: '<iframe src="console.html"></iframe>',
        left: 20,
        top: 120,
        iconUrl: "icons/console.png"
      },
      {
        name: "Notepad",
        type: "app",
        content: '<iframe src="notepad.html"></iframe>',
        left: 20,
        top: 220,
        iconUrl: "icons/notepad.png"
      }
    ];
    (async function initDesktop() {
      console.log("Initializing desktop...");
      let desktopFolder = await db.files
        .where({ name: "Desktop", type: "folder", parentId: 0 })
        .first();

      // if missing, create it
      if (!desktopFolder) {
        const id = await db.files.add({
          name: "Desktop",
          type: "folder",
          parentId: 0,
          content: "",
          left: 0,
          top: 0,
          iconUrl: ""
        });
        desktopFolder = { id };
      }
      for (const app of defaultApps) {
        const exists = await db.files
          .where({ parentId: desktopFolder.id, name: app.name })
          .first();
        if (!exists) {
          await db.files.add({
            name: app.name,
            type: app.type,
            parentId: desktopFolder.id,
            content: app.content,
            left: app.left,
            top: app.top,
            iconUrl: app.iconUrl
          });
        }
      }
      // now render whatever’s inside it
      await loadDesktopIcons(desktopFolder.id);
    })();
    let rightClickedElement = null;
    let mouseX = 0;
    let mouseY = 0;
    document.addEventListener("contextmenu", (e) => {
      e.preventDefault();

      rightClickedElement = e.target.closest('.desktop-icon');

      const menu = document.getElementById("custom-menu");
      const fileMenu = document.getElementById("file-menu");
      const emptyMenu = document.getElementById("empty-menu");

      // Reset
      fileMenu.style.display = "none";
      emptyMenu.style.display = "none";

      // Show the appropriate menu
      if (rightClickedElement) {
        fileMenu.style.display = "block";
      } else {
        emptyMenu.style.display = "block";
      }

      menu.style.display = "block";
      menu.style.left = `${e.pageX}px`;
      menu.style.top = `${e.pageY}px`;
    });

    document.addEventListener("click", () => {
      document.getElementById("custom-menu").style.display = "none";
    });

    window.addEventListener("resize", () => {
      document.getElementById("custom-menu").style.display = "none";
    });
    async function loadDesktopIcons(folderId) {
      // clear existing icons
      WindowManager.desktop.innerHTML = "";

      // get all items in this folder
      const items = await db.files.where({ parentId: folderId }).toArray();

      // for each, create an icon
      items.forEach(item => {
        createDesktopIcon(
          item.id,
          item.name + defaultFileType(item.type),
          getAppContent(item),
          item.left + "px",
          item.top + "px",
          item.iconUrl || defaultIconFor(item.type)
        );
      });
    }
    function defaultFileType(type) {
      return type === "folder"
        ? ""
        : type === "app"
          ? ".app"
          : type === "file"
            ? ".txt"
            : ".?";
    }
    function defaultIconFor(type) {
      return type === "folder"
        ? "icons/folder.png"
        : "icons/notepad.png";
    }

    function getAppContent(item) {
      if (item.type === "folder") {
        return `<iframe src="explorer.html?folderId=${item.id}"></iframe>`;
      } else if (item.type === "app") {
        return item.content;
      } else if (item.type === "file") {
        return `<iframe src="notepad.html?fileId=${item.id}"></iframe>`;
      }
    }


    async function getDesktopFolderId() {
      const folder = await db.files
        .where({ name: "Desktop", type: "folder", parentId: 0 })
        .first();
      console.log(folder);
      return folder.id;
    }

    async function renameFile() {
      if (!rightClickedElement) return;
      const id = parseInt(rightClickedElement.dataset.windowId, 10);
      const oldName = rightClickedElement.querySelector("span").textContent.replace(/\.[^/.]+$/, '');
      const newName = prompt("New name:", oldName);
      if (newName && newName !== oldName) {
        await db.files.update(id, { name: newName });
        await loadDesktopIcons(await getDesktopFolderId());
      }
    }

    async function deleteFile() {
      if (!rightClickedElement) return;
      const id = parseInt(rightClickedElement.dataset.windowId, 10);
      if (confirm("Delete this item?")) {
        await db.files.delete(id);
        await loadDesktopIcons(await getDesktopFolderId());
      }
    }

    async function createFile() {
      const name = prompt("File name:", "New File");
      if (!name) return;

      // grid‐snapped mouseX, mouseY from your contextmenu handler
      const { left, top } = normalizePosition(mouseX, mouseY);
      console.log(left, top);
      const id = await db.files.add({
        name,
        type: "file",
        parentId: await getDesktopFolderId(),
        content: "",
        left: parseInt(left),
        top: parseInt(top),
        iconUrl: "icons/notepad.png"
      });
      await loadDesktopIcons(await getDesktopFolderId());
    }

    async function createFolder() {
      const name = prompt("Folder name:", "New Folder");
      if (!name) return;

      const { left, top } = normalizePosition(mouseX, mouseY);
      await db.files.add({
        name,
        type: "folder",
        parentId: await getDesktopFolderId(),
        content: "",
        left: parseInt(left),
        top: parseInt(top),
        iconUrl: "icons/folder.png"
      });
      await loadDesktopIcons(await getDesktopFolderId());
    }
    function normalizePosition(x, y) {
      const gridSize = 100; // Adjust for icon size + margin
      const menu = document.getElementById('empty-menu');
      const bounds = menu.getBoundingClientRect();

      const relX = bounds.left;
      const relY = bounds.top;

      const snappedX = Math.floor(relX / gridSize) * gridSize;
      const snappedY = Math.floor(relY / gridSize) * gridSize;
      console.log(relX, relY);
      return {
        left: Math.max(snappedX + 20, 0),
        top: Math.max(snappedY + 20, 0)
      };
    }

    const WindowManager = {
      windows: {},
      zIndex: 10,
      desktop: document.getElementById('desktop'),
      taskbar: document.getElementById('taskbar'),

      createWindow: function (id, title, content) {
        if (this.windows[id]) {
          // If window already exists, bring it to the front
          this.bringToFront(this.windows[id].element);
          return;
        }
        // Create window element
        const win = document.createElement('div');
        win.classList.add('window');
        win.style.width = '960px';
        win.style.height = '430px';
        win.style.left = `${100 + 10 * Object.keys(this.windows).length}px`;
        win.style.top = `${100 + 10 * Object.keys(this.windows).length}px`;
        win.style.zIndex = ++this.zIndex;
        win.dataset.windowId = id;

        // Create header with controls
        const header = document.createElement('div');
        header.classList.add('window-header');
        header.innerHTML = `
          <span class="title">${title}</span>
          <span class="window-controls">
            <span class="minimize">_</span>
            <span class="maximize">[ ]</span>
            <span class="close">&times;</span>
          </span>
        `;

        // Create window body
        const body = document.createElement('div');
        body.classList.add('window-body');
        body.innerHTML = content;

        // Create resizable handle
        const resizeHandle = document.createElement('div');
        resizeHandle.classList.add('resize-handle');

        win.appendChild(header);
        win.appendChild(body);
        win.appendChild(resizeHandle);
        this.desktop.appendChild(win);

        // Store window data
        this.windows[id] = {
          element: win,
          header: header,
          body: body,
          resizeHandle: resizeHandle,
          minimized: false,
          maximized: false,
          prevPosition: {
            left: win.style.left,
            top: win.style.top,
            width: win.style.width,
            height: win.style.height
          }
        };

        // Event listeners for window controls
        header.querySelector('.close').addEventListener('click', () => {
          this.closeWindow(id);
        });
        header.querySelector('.minimize').addEventListener('click', () => {
          this.minimizeWindow(id);
        });
        header.querySelector('.maximize').addEventListener('click', () => {
          this.maximizeWindow(id);
        });

        // Make window draggable via its header
        this.makeDraggable(win, header);
        // Make window resizable via its resize handle
        this.makeResizable(win, resizeHandle);

        // Create taskbar item for this window
        const taskbarItem = document.createElement('div');
        taskbarItem.classList.add('taskbar-item');
        taskbarItem.textContent = title;
        taskbarItem.dataset.windowId = id;
        taskbarItem.addEventListener('click', () => {
          this.toggleWindow(id);
        });
        this.taskbar.appendChild(taskbarItem);
        this.windows[id].taskbarItem = taskbarItem;

        // Bring window to front when clicked
        win.addEventListener('mousedown', () => {
          this.bringToFront(win);
        });
      },

      bringToFront: function (win) {
        win.style.zIndex = ++this.zIndex;
      },

      closeWindow: function (id) {
        if (this.windows[id]) {
          const win = this.windows[id].element;
          this.desktop.removeChild(win);
          this.taskbar.removeChild(this.windows[id].taskbarItem);
          delete this.windows[id];
        }
      },

      minimizeWindow: function (id) {
        if (this.windows[id]) {
          const win = this.windows[id].element;
          win.style.display = 'none';
          this.windows[id].minimized = true;
        }
      },

      maximizeWindow: function (id) {
        if (this.windows[id]) {
          const winObj = this.windows[id];
          const win = winObj.element;
          if (!winObj.maximized) {
            // Save current position and size
            winObj.prevPosition = {
              left: win.style.left,
              top: win.style.top,
              width: win.style.width,
              height: win.style.height
            };
            win.style.left = '0';
            win.style.top = '0';
            win.style.width = this.desktop.clientWidth + 'px';
            // Adjust height to account for the taskbar
            win.style.height = (this.desktop.clientHeight - this.taskbar.clientHeight) + 'px';
            winObj.maximized = true;
          } else {
            // Restore previous dimensions
            win.style.left = winObj.prevPosition.left;
            win.style.top = winObj.prevPosition.top;
            win.style.width = winObj.prevPosition.width;
            win.style.height = winObj.prevPosition.height;
            winObj.maximized = false;
          }
          this.bringToFront(win);
        }
      },

      toggleWindow: function (id) {
        if (this.windows[id]) {
          const win = this.windows[id].element;
          if (win.style.display === 'none') {
            win.style.display = 'block';
            this.bringToFront(win);
            this.windows[id].minimized = false;
          } else {
            win.style.display = 'none';
            this.windows[id].minimized = true;
          }
        }
      },

      // Enable dragging of windows by their header
      makeDraggable: function (elmnt, handle) {
        let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
        handle.onmousedown = dragMouseDown;

        const self = this;
        function dragMouseDown(e) {
          e.preventDefault();
          pos3 = e.clientX;
          pos4 = e.clientY;
          document.onmouseup = closeDragElement;
          document.onmousemove = elementDrag;
          self.bringToFront(elmnt);
        }

        function elementDrag(e) {
          e.preventDefault();
          pos1 = pos3 - e.clientX;
          pos2 = pos4 - e.clientY;
          pos3 = e.clientX;
          pos4 = e.clientY;
          elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
          elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
        }

        function closeDragElement() {
          document.onmouseup = null;
          document.onmousemove = null;
        }
      },

      // Enable resizing of windows using the resize handle
      makeResizable: function (elmnt, handle) {
        let startX, startY, startWidth, startHeight;
        handle.addEventListener('mousedown', initResize);

        function initResize(e) {
          e.preventDefault();
          startX = e.clientX;
          startY = e.clientY;
          startWidth = parseInt(document.defaultView.getComputedStyle(elmnt).width, 10);
          startHeight = parseInt(document.defaultView.getComputedStyle(elmnt).height, 10);
          document.documentElement.addEventListener('mousemove', doResize, false);
          document.documentElement.addEventListener('mouseup', stopResize, false);
        }

        function doResize(e) {
          console.log(e.clientX, e.clientY);
          elmnt.style.width = (startWidth + e.clientX - startX) + 'px';
          elmnt.style.height = (startHeight + e.clientY - startY) + 'px';
        }

        function stopResize() {
          document.documentElement.removeEventListener('mousemove', doResize, false);
          document.documentElement.removeEventListener('mouseup', stopResize, false);
        }
      }
    };
    function openFile(app) {
      WindowManager.createWindow(app.id, app.name, getAppContent(app));
    }
    // Helper: Create a desktop icon that opens a window when double-clicked
    function createDesktopIcon(id, title, content, left, top, iconUrl) {
      const icon = document.createElement('div');
      icon.classList.add('desktop-icon');
      icon.style.left = left;
      icon.style.top = top;
      icon.dataset.windowId = id;
      icon.innerHTML = `
        <img src="${iconUrl}" alt="${title}">
        <span>${title}</span>
      `;
      icon.addEventListener('dblclick', () => {
        WindowManager.createWindow(id, title, content);
      });
      WindowManager.desktop.appendChild(icon);
    }
    const startButton = document.getElementById("start-button");
    const startMenu = document.getElementById("start-menu");

    startButton.addEventListener("click", () => {
      startMenu.style.display = startMenu.style.display === "block" ? "none" : "block";
    });

    // Close start menu on outside click
    document.addEventListener("click", (e) => {
      if (!startMenu.contains(e.target) && e.target !== startButton) {
        startMenu.style.display = "none";
      }
    });

    function launchApp(appName) {
      db.files.where("name").equals(appName).first().then(app => {
        if (app) {
          console.log(app);
          WindowManager.createWindow(app.id, app.name, getAppContent(app));
        } else {
          alert(`${appName} not found`);
        }
        startMenu.style.display = "none";
      });
    }


  </script>
</body>

</html>